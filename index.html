<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Omeglo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- SOCKET.IO -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }
    body { margin: 0; background: #0e0f13; color: #fff; }
    header {
      background: linear-gradient(90deg,#4f46e5,#9333ea);
      padding: 12px 20px;
      font-size: 20px;
      font-weight: bold;
    }
    .container { display: flex; height: calc(100vh - 50px); }
    .left { width: 300px; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
    .video { background: #000; border: 1px solid #333; height: 220px; display:flex;align-items:center;justify-content:center; }
    .right { flex: 1; display: flex; flex-direction: column; padding: 10px; }
    .top-bar { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; }
    #messages { flex: 1; background: #12141c; border: 1px solid #333; padding: 10px; overflow-y: auto; }
    .msg { margin-bottom: 6px; }
    .me { color: #60a5fa; }
    .stranger { color: #a78bfa; }
    .input-bar { display: flex; gap: 6px; margin-top: 6px; }
    input { flex: 1; padding: 8px; background: #0f172a; color: #fff; border: 1px solid #333; }
    button { padding: 8px 14px; border: none; cursor: pointer; background: #4f46e5; color: white; }
    button.secondary { background: #374151; }

    /* LANDING */
    .landing {
      position: fixed; inset: 0; background: #0e0f13;
      display: flex; align-items: center; justify-content: center; z-index: 99;
    }
    .landing-box {
      background: #12141c; padding: 30px;
      border: 1px solid #333; width: 320px;
    }
  </style>
</head>

<body>
<header>Omeglo</header>

<!-- ðŸ”ž 18+ LANDING -->
<div class="landing" id="landing">
  <div class="landing-box">
    <h2>18+ Warning</h2>
    <p>This site may contain adult content.</p>
    <input id="interestInput" placeholder="Enter interests (optional)">
    <button onclick="startChat()">I Agree, Start</button>
  </div>
</div>

<div class="container">
  <div class="left">
    <div class="video" id="localVideo">Your video</div>
    <div class="video" id="remoteVideo">Stranger video</div>
    <button class="secondary" onclick="fullscreen()">Fullscreen</button>
  </div>

  <div class="right">
    <div class="top-bar">
      <div id="status">Connectingâ€¦</div>
      <div>Online now: <span id="online">0</span></div>
    </div>

    <div id="messages"></div>

    <div class="input-bar">
      <input id="msgInput" placeholder="Type messageâ€¦" />
      <button onclick="sendMsg()">Send</button>
      <button class="secondary" onclick="nextChat()">Next</button>
      <button class="secondary" onclick="report()">Report</button>
    </div>
  </div>
</div>

<script>
/* =====================
   SOCKET CONNECT
===================== */
const socket = io("https://omeglo-server.onrender.com", {
  transports: ["websocket"]
});

const online = document.getElementById("online");
const statusEl = document.getElementById("status");
const messages = document.getElementById("messages");
const input = document.getElementById("msgInput");

/* =====================
   ONLINE COUNT
===================== */
socket.on("online-count", n => {
  console.log("ONLINE:", n);
  online.innerText = n;
});

/* =====================
   CHAT EVENTS
===================== */
socket.on("matched", () => {
  statusEl.innerText = "Connected with stranger";
});

socket.on("message", msg => addMsg("stranger", msg));

socket.on("partner_left", () => {
  statusEl.innerText = "Stranger left";
});

socket.on("banned", msg => {
  alert(msg);
  location.reload();
});

/* =====================
   VIDEO
===================== */
let localStream = null;

async function startLocalVideo() {
  localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
  const v = document.createElement("video");
  v.srcObject = localStream;
  v.autoplay = true;
  v.muted = true;
  v.style.width = "100%";
  document.getElementById("localVideo").innerHTML = "";
  document.getElementById("localVideo").appendChild(v);
}

/* =====================
   FUNCTIONS
===================== */
function startChat() {
  document.getElementById("landing").style.display = "none";
  startLocalVideo();
  socket.emit("join");
  statusEl.innerText = "Finding strangerâ€¦";
}

function sendMsg() {
  const text = input.value.trim();
  if (!text) return;
  socket.emit("message", text);
  addMsg("me", text);
  input.value = "";
}

function nextChat() {
  messages.innerHTML = "";
  socket.emit("next");
  statusEl.innerText = "Finding new strangerâ€¦";
}

function report() {
  socket.emit("report");
}

function addMsg(type, text) {
  const d = document.createElement("div");
  d.className = "msg " + type;
  d.innerText = (type==="me"?"You: ":"Stranger: ") + text;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
}

function fullscreen() {
  document.documentElement.requestFullscreen();
}
</script>
</body>
</html>
